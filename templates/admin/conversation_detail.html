<!doctype html>
<html lang="en">

<head>
  {% include 'admin/layout_head.html' %}
  <title>Admin - Conversation Detail</title>
  <style>
    html, body {
      height: 100%;
    }
    .main-content {
      height: 100vh;
    }
    .chat-wrapper {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 64px);
    }
    .messages-area {
      overflow-y: auto;
    }
    .sidebar-panel {
      height: calc(100vh - 64px);
      overflow-y: auto;
    }
  </style>
</head>

<body>
  <div class="app-container">
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleSidebar()">
      <i class="fa-solid fa-bars"></i>
    </button>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <img src="/static/logo.png" alt="AI Hotel Suite" style="width:24px;height:24px;border-radius:4px;" class="me-2"> AI Hotel Suite
        </div>
      </div>
      <nav class="sidebar-nav d-flex flex-column">
        <a href="#" id="tasksLinkSidebar" class="nav-item">
          <i class="fa-solid fa-list-check"></i> <span data-i18n="nav_tasks">Tasks</span>
        </a>
        <a href="#" id="conversationsLinkSidebar" class="nav-item active">
          <i class="fa-solid fa-comments"></i> <span data-i18n="nav_conversations">Conversations</span>
        </a>
        <div class="flex-grow-1"></div>
        <hr class="my-2 text-muted opacity-50">
        <a href="#" id="aiSettingsLinkSidebar" class="nav-item">
          <i class="fa-solid fa-brain"></i> <span data-i18n="nav_ai_settings">AI Settings</span>
        </a>
        <a href="#" id="integrationsLinkSidebar" class="nav-item">
          <i class="fa-solid fa-plug"></i> <span data-i18n="nav_integrations">Integrations</span>
        </a>
        <a href="#" id="subscriptionLinkSidebar" class="nav-item d-none">
          <i class="fa-solid fa-credit-card"></i> <span data-i18n="nav_subscription">Subscription</span>
        </a>
        <a href="#" id="helpLinkSidebar" class="nav-item">
          <i class="fa-solid fa-circle-question"></i> <span data-i18n="nav_help">Help</span>
        </a>
      </nav>
      {% include 'admin/sidebar_footer.html' %}
    </aside>

    <!-- Main Content -->
    <main class="main-content h-100 d-flex flex-column p-0">
      <!-- Header -->
      <div class="bg-white border-bottom px-4 py-3 d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <a id="backLink" href="#" class="btn btn-outline-secondary btn-sm me-3 border-0">
            <i class="fa-solid fa-arrow-left"></i>
          </a>
          <div>
            <h5 class="mb-0" data-i18n="conv_detail_title">Conversation Details</h5>
            <small class="text-muted" id="header-subtitle" data-i18n="loading_common">Loading...</small>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button type="button" class="btn btn-sm btn-outline-secondary position-relative" id="notificationBell" data-i18n-title="notif_label" aria-label="Notifications">
            <i class="fa-regular fa-bell"></i>
            <span id="notificationBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">0</span>
          </button>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="notificationMute" data-i18n-title="notif_sound_on" aria-label="Sound">
            <i class="fa-solid fa-volume-high"></i>
          </button>
          <select id="lang-select" class="form-select form-select-sm lang-select-sm">
            <option value="en" data-i18n="lang_en">ðŸ‡¬ðŸ‡§ English</option>
            <option value="ro" data-i18n="lang_ro">ðŸ‡·ðŸ‡´ RomÃ¢nÄƒ</option>
            <option value="th" data-i18n="lang_th">ðŸ‡¹ðŸ‡­ à¹„à¸—à¸¢</option>
          </select>
        </div>
      </div>

      <div class="container-fluid flex-grow-1 overflow-hidden chat-wrapper">
        <div class="row h-100">
          <!-- Chat Area -->
          <div class="col-md-8 h-100 p-0 d-flex flex-column bg-light">
            <div class="messages-area flex-grow-1" id="messages">
              <!-- Messages will be injected here -->
            </div>
            <div class="border-top bg-white p-3">
              <label class="form-label small fw-semibold text-muted" data-i18n="conv_send_to_guest">Trimite mesaj cÄƒtre oaspete</label>
              <div class="d-flex gap-2">
                <textarea class="form-control" id="manualMessage" rows="2" data-i18n-placeholder="conv_send_message_ph" placeholder="Scrie mesajul..." style="resize: none;"></textarea>
                <button class="btn btn-primary" id="sendManualBtn"><i class="fa-solid fa-paper-plane me-1"></i><span data-i18n="btn_send">Trimite</span></button>
              </div>
            </div>
          </div>

          <!-- Info Sidebar -->
          <div class="col-md-4 h-100 border-start bg-white sidebar-panel p-4">
            <button class="btn btn-warning w-100 mb-3" id="togglePauseBtn" data-i18n="conv_take_control">Take Control</button>
            <h6 class="text-uppercase text-muted small fw-bold mb-3" data-i18n="conv_info_title">Conversation Info</h6>
            <div id="info" class="mb-4">
              <!-- Info injected here -->
            </div>

            <h6 class="text-uppercase text-muted small fw-bold mb-3 d-flex justify-content-between align-items-center">
              <span data-i18n="conv_related_tasks">Related Tasks</span>
              <span class="badge bg-secondary rounded-pill" id="task-count">0</span>
            </h6>
            <ul class="list-group list-group-flush" id="tasks">
              <!-- Tasks injected here -->
            </ul>
          </div>
        </div>
      </div>
    </main>
  </div>
  <div id="notificationToasts" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080;"></div>

  <script>
    const tokenKey = "token";
    const urlToken = new URLSearchParams(window.location.search).get("token");
    if (urlToken) localStorage.setItem(tokenKey, urlToken);

    function getToken() {
      return localStorage.getItem(tokenKey);
    }

    function handleUnauthorized() {
      localStorage.removeItem(tokenKey);
      document.cookie = "admin_token=; Max-Age=0; path=/";
      window.location = "/ui/admin/login";
    }

    function conversationId() {
      const parts = window.location.pathname.split("/");
      return parts[parts.length - 1];
    }

    function authQuery() {
      const t = getToken();
      return t ? `?token=${encodeURIComponent(t)}` : "";
    }

    // XSS Protection: Escape HTML to prevent script injection
    function escapeHtml(text) {
      if (text == null) return '';
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

  function renderMessages(messages) {
    const container = document.getElementById("messages");
    if (!messages.length) {
      container.innerHTML = `<div class='text-center text-muted mt-5'><i class='fa-regular fa-comments fa-2x mb-3'></i><p>${I18N.t('conv_no_messages')}</p></div>`;
      return;
    }
      container.innerHTML = "";
      messages.forEach(m => {
        const isOutbound = m.direction === 'OUTGOING';
        const bubbleClass = isOutbound ? 'outbound' : 'inbound';
        let senderName = m.sender_type === 'STAFF'
          ? (I18N.t('conv_msg_staff') || 'Staff')
          : (m.sender_type === 'BOT' ? I18N.t('conv_msg_bot') : I18N.t('conv_msg_guest'));

      const div = document.createElement("div");
      div.className = `message-bubble ${bubbleClass}`;

      // Create message meta safely
      const metaDiv = document.createElement('div');
      metaDiv.className = 'message-meta';

      const senderSpan = document.createElement('span');
      senderSpan.className = 'fw-bold';
      senderSpan.textContent = senderName;

      const timeSpan = document.createElement('span');
      timeSpan.textContent = m.created_at ? new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';

      metaDiv.appendChild(senderSpan);
      metaDiv.appendChild(timeSpan);

      // Create message content safely (NO HTML EXECUTION)
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.textContent = m.text;  // âœ… SAFE - textContent escapes HTML automatically

      div.appendChild(metaDiv);
      div.appendChild(contentDiv);
      container.appendChild(div);
    });
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
  }

    function renderInfo(conv) {
      const paused = conv.is_bot_paused;
      const headerTpl = I18N.t('conv_header_summary') || 'ID: #{id} â€¢ {hotel} â€¢ {guest} â€¢ Room {room}';
      document.getElementById("header-subtitle").textContent = headerTpl
        .replace("{id}", conv.id)
        .replace("{hotel}", conv.hotel_id)
        .replace("{guest}", conv.guest_name || I18N.t('conv_guest_generic'))
        .replace("{room}", conv.room_number || "-");
      const toggleBtn = document.getElementById("togglePauseBtn");
      if (toggleBtn) {
        const i18nKey = paused ? "conv_return_ai" : "conv_take_control";
        toggleBtn.setAttribute("data-i18n", i18nKey);
        toggleBtn.textContent = I18N.t(i18nKey);
        toggleBtn.className = paused ? "btn btn-success w-100 mb-3" : "btn btn-warning w-100 mb-3";
      }

      const el = document.getElementById("info");
      el.innerHTML = `
        <div class="card border-0 bg-light mb-3">
          <div class="card-body p-3">
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted small" data-i18n="conv_info_status">${escapeHtml(I18N.t('conv_info_status'))}</span>
              <span class="badge bg-secondary">${conv.status ? escapeHtml(I18N.t('status_' + conv.status.toLowerCase()) || conv.status) : ''}</span>
            </div>
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted small" data-i18n="conv_info_guest_id">${escapeHtml(I18N.t('conv_info_guest_id'))}</span>
            <span class="fw-medium text-end text-truncate" style="max-width: 150px;">${escapeHtml(conv.guest_name || conv.guest_id)}</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted small" data-i18n="conv_info_stay_id">${escapeHtml(I18N.t('conv_info_stay_id'))}</span>
            <span class="fw-medium">${escapeHtml(conv.stay_id ?? "-")}</span>
          </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted small" data-i18n="label_room">${escapeHtml(I18N.t('label_room') || 'Room')}</span>
              <span class="fw-medium">${escapeHtml(conv.room_number ?? "-")}</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="text-muted small" data-i18n="conv_info_handler">${escapeHtml(I18N.t('conv_info_handler'))}</span>
            <span class="fw-medium">${escapeHtml(conv.current_handler)}</span>
          </div>
          <div class="d-flex justify-content-between mt-2">
            <span class="text-muted small" data-i18n="conv_bot_paused">Bot paused</span>
            <span class="fw-medium">${paused ? escapeHtml(I18N.t('yes') || 'Yes') : escapeHtml(I18N.t('no') || 'No')}</span>
            </div>
          </div>
        </div>

        <div class="small text-muted">
          <div class="mb-1"><i class="fa-regular fa-clock me-2"></i><span data-i18n="conv_info_created">${escapeHtml(I18N.t('conv_info_created'))}</span>: ${escapeHtml(conv.created_at)}</div>
          <div><i class="fa-solid fa-rotate me-2"></i><span data-i18n="conv_info_updated">${escapeHtml(I18N.t('conv_info_updated'))}</span>: ${escapeHtml(conv.updated_at)}</div>
        </div>
      `;
      // Re-apply i18n to newly inserted elements
      I18N.apply();
    }

    function renderTasks(tasks) {
      const list = document.getElementById("tasks");
      document.getElementById("task-count").textContent = tasks.length;

      if (!tasks.length) {
        list.innerHTML = `<li class='list-group-item bg-transparent text-muted small text-center py-3'>${I18N.t('conv_no_tasks')}</li>`;
        return;
      }
      list.innerHTML = "";
      tasks.forEach(t => {
        const li = document.createElement("li");
        li.className = "list-group-item bg-transparent px-0 py-3 border-bottom";

        let statusColor = 'text-secondary';
        if (t.status === 'DONE') statusColor = 'text-success';
        if (t.status === 'NEW') statusColor = 'text-primary';

        const typeKey = t.type ? `task_${t.type.toLowerCase()}` : null;
        const typeLabel = typeKey ? (I18N.t(typeKey) || t.type) : (t.type || '');

        li.innerHTML = `
          <div class="d-flex justify-content-between align-items-start mb-1">
            <span class="fw-medium">${typeLabel}</span>
            <span class="small fw-bold ${statusColor}">${t.status ? (I18N.t('status_' + t.status.toLowerCase()) || t.status) : ''}</span>
          </div>
          <div class="small text-muted mb-1">${I18N.t('conv_info_created')}: ${t.created_at}</div>
          ${t.completed_at ? `<div class="small text-muted"><i class="fa-solid fa-check me-1"></i>${t.completed_at}</div>` : ''}
        `;
        list.appendChild(li);
      });
    }

    async function loadConversation() {
      const token = getToken();
      if (!token) {
        handleUnauthorized();
        return;
      }
      const cid = conversationId();
      document.getElementById("messages").innerHTML = "<div class='text-center mt-5'><div class='spinner-border text-primary' role='status'></div></div>";
      const resp = await fetch(`/admin/conversations/${cid}`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      if (!resp.ok) {
        handleUnauthorized();
        return;
      }
      const data = await resp.json();
      renderInfo(data.conversation);
      renderMessages(data.messages);
      renderTasks(data.tasks || []);
      window.currentConversation = data.conversation;
    }

    async function togglePause() {
      const token = getToken();
      if (!token) {
        handleUnauthorized();
        return;
      }
      const cid = conversationId();
      const paused = !(window.currentConversation?.is_bot_paused);
      const resp = await fetch(`/admin/conversations/${cid}/toggle-pause`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify({ paused })
      });
      if (!resp.ok) {
        alert(I18N.t('conv_toggle_failed'));
        return;
      }
      await loadConversation();
    }

    async function sendManual() {
      const token = getToken();
      if (!token) {
        handleUnauthorized();
        return;
      }
      const cid = conversationId();
      const msg = document.getElementById("manualMessage").value.trim();
      if (!msg) return;
      const btn = document.getElementById("sendManualBtn");
      btn.disabled = true;
      const resp = await fetch(`/admin/conversations/${cid}/send-message`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify({ message: msg })
      });
      btn.disabled = false;
      if (!resp.ok) {
        alert(I18N.t('conv_send_failed'));
        return;
      }
      document.getElementById("manualMessage").value = "";
      await loadConversation();
    }

    // Initialize language selector
    I18N.initSelect('lang-select');
    I18N.apply();

    // Reload conversation when language changes
    window.addEventListener('languageChanged', () => {
      loadConversation();
      I18N.apply();
    });

    document.getElementById("togglePauseBtn").addEventListener("click", togglePause);
    document.getElementById("sendManualBtn").addEventListener("click", sendManual);
    // Enter key to send message (Shift+Enter for new line)
    document.getElementById("manualMessage").addEventListener("keydown", function(e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendManual();
      }
    });
    loadConversation();
    document.getElementById("backLink").href = "/ui/admin/conversations" + authQuery();
    document.getElementById("conversationsLinkSidebar").href = "/ui/admin/conversations" + authQuery();
    document.getElementById("tasksLinkSidebar").href = "/ui/admin/tasks" + authQuery();
    document.getElementById("aiSettingsLinkSidebar").href = "/ui/admin/settings/ai" + authQuery();
    document.getElementById("integrationsLinkSidebar").href = "/ui/admin/settings/integrations" + authQuery();
    document.getElementById("helpLinkSidebar").href = "/ui/admin/help" + authQuery();
  </script>

  {% include 'admin/change_password_modal.html' %}

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/js/admin-sidebar.js?v=2"></script>
  <script src="/static/js/notifications.js"></script>
  <script src="/static/js/subscription.js"></script>
</body>

</html>
