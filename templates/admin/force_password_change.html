<!doctype html>
<html lang="en">

<head>
  <!-- Cookie Consent + Analytics -->
  <script src="/static/js/cookie-consent.js?v=2" defer></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/static/logo-icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Kanit:wght@300;400;600&display=swap"
    rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              black: '#0a0a0a',
              dark: '#1c1917',
              gray: '#57534e',
              light: '#fafaf9',
              accent: '#44403c'
            }
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            thai: ['Kanit', 'sans-serif'],
          },
        }
      }
    }
  </script>
  <script src="/static/js/i18n.js"></script>
  <style>
    [lang="th"] {
      font-family: 'Kanit', sans-serif !important;
    }

    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
  <title data-i18n="change_password">Change Password</title>
</head>

<body class="font-sans antialiased bg-stone-50 text-stone-900 min-h-screen flex items-center justify-center p-4">

  <div class="w-full max-w-md bg-white rounded-3xl shadow-xl border border-stone-100 overflow-hidden fade-in">
    <div class="p-8 md:p-10">

      <div class="text-center mb-8">
        <img src="/static/logo.png" alt="AI Hotel Suite" class="w-16 h-16 mx-auto mb-4 rounded-xl shadow-lg shadow-stone-200">
        <h1 class="text-2xl font-bold text-stone-900 mb-2" data-i18n="force_change_title">Set a new password</h1>
        <p class="text-stone-500 text-sm" data-i18n="force_change_subtitle">Please set a new password to continue.</p>
      </div>

      <div class="space-y-5">
        <div>
          <label class="block text-sm font-semibold text-stone-700 mb-2" data-i18n="force_new_password">New
            Password</label>
          <input type="password" id="newPassword" placeholder="••••••••"
            class="w-full px-4 py-3 bg-stone-50 border border-stone-200 rounded-xl focus:ring-2 focus:ring-stone-900 focus:border-stone-900 outline-none transition-all placeholder-stone-400">
        </div>
        <div>
          <label class="block text-sm font-semibold text-stone-700 mb-2" data-i18n="force_confirm_password">Confirm
            Password</label>
          <input type="password" id="confirmPassword" placeholder="••••••••"
            class="w-full px-4 py-3 bg-stone-50 border border-stone-200 rounded-xl focus:ring-2 focus:ring-stone-900 focus:border-stone-900 outline-none transition-all placeholder-stone-400">
        </div>

        <div id="error" class="p-3 rounded-lg bg-red-50 text-red-600 text-sm font-medium hidden"></div>

        <button id="changeBtn"
          class="w-full py-3.5 bg-stone-900 hover:bg-stone-800 text-white rounded-xl font-bold shadow-lg shadow-stone-900/20 transition-all hover:-translate-y-0.5"
          data-i18n="force_save_continue">
          Save and Continue
        </button>
      </div>

    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      I18N.apply();
    });
    const tokenParam = new URLSearchParams(window.location.search).get("token");
    const tokenKey = "token";
    if (tokenParam) localStorage.setItem(tokenKey, tokenParam);
    function getToken() { return localStorage.getItem(tokenKey); }

    document.getElementById("changeBtn").addEventListener("click", async () => {
      const pass1 = document.getElementById("newPassword").value.trim();
      const pass2 = document.getElementById("confirmPassword").value.trim();
      const errorEl = document.getElementById("error");
      errorEl.classList.add("hidden");

      if (!pass1 || pass1.length < 6 || pass1 !== pass2) {
        errorEl.textContent = I18N.t('force_error_mismatch') || "Passwords mismatch or too short";
        errorEl.classList.remove("hidden");
        return;
      }
      const token = getToken();
      if (!token) {
        window.location = "/ui/admin/login";
        return;
      }

      const btn = document.getElementById("changeBtn");
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.innerHTML = '<svg class="animate-spin h-5 w-5 mx-auto text-stone-900" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

      try {
        const resp = await fetch("/auth/change-password-force", {
          method: "POST",
          headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
          body: JSON.stringify({ new_password: pass1 })
        });
        if (!resp.ok) {
          const errData = await resp.json().catch(() => ({}));
          errorEl.textContent = errData.detail || I18N.t('force_error_save') || "Failed to save password";
          errorEl.classList.remove("hidden");
          btn.disabled = false;
          btn.textContent = originalText;
          return;
        }
        window.location = `/ui/admin/settings/ai?token=${encodeURIComponent(token)}`;
      } catch (e) {
        errorEl.textContent = "Network error occurred";
        errorEl.classList.remove("hidden");
        btn.disabled = false;
        btn.textContent = originalText;
      }
    });
  </script>
</body>

</html>