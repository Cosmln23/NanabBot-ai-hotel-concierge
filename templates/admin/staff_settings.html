<!doctype html>
<html lang="en">

<head>
  <!-- Cookie Consent + Analytics -->
  <script src="/static/js/cookie-consent.js?v=2" defer></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="/static/js/i18n.js"></script>
  <title>Staff Settings</title>
</head>

<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h4 class="mb-0" data-i18n="staff_title">Staff Settings</h4>
        <p class="text-muted small mb-0" data-i18n="staff_subtitle">Manage staff accounts and permissions.</p>
      </div>
      <div class="d-flex gap-2">
        <select id="lang-select" class="form-select form-select-sm lang-select-sm">
          <option value="en" data-i18n="lang_en">ðŸ‡¬ðŸ‡§ English</option>
        </select>
        <a href="/ui/admin/conversations" class="btn btn-outline-secondary btn-sm" data-i18n="btn_back">Back</a>
      </div>
    </div>
    <!-- Trial Banner -->
    <div id="trialBanner" class="alert alert-warning d-none mb-3" role="alert">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
          <i class="fa-solid fa-clock me-2"></i>
          <span data-i18n="trial_banner_text">Trial:</span>
          <strong id="trialDaysLeft">0</strong>
          <span data-i18n="trial_days_remaining">days remaining</span>
        </div>
        <div class="d-flex gap-2">
          <a href="/upgrade" class="btn btn-outline-dark btn-sm">
            <i class="fa-solid fa-crown me-1"></i><span data-i18n="trial_upgrade_btn">Upgrade Basic</span>
          </a>
          <a href="/upgrade-pro" class="btn btn-warning btn-sm">
            <i class="fa-solid fa-star me-1"></i><span data-i18n="trial_upgrade_pro_btn">Upgrade PRO</span>
          </a>
        </div>
      </div>
    </div>
    <!-- Trial Expired Banner -->
    <div id="trialExpiredBanner" class="alert alert-danger d-none mb-3" role="alert">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
          <i class="fa-solid fa-exclamation-triangle me-2"></i>
          <span data-i18n="trial_expired_text">Trial expired! Your bot is stopped. Upgrade to continue.</span>
        </div>
        <div class="d-flex gap-2">
          <a href="/upgrade" class="btn btn-outline-danger btn-sm">
            <i class="fa-solid fa-crown me-1"></i><span data-i18n="trial_upgrade_btn">Upgrade Basic</span>
          </a>
          <a href="/upgrade-pro" class="btn btn-danger btn-sm">
            <i class="fa-solid fa-star me-1"></i><span data-i18n="trial_upgrade_pro_btn">Upgrade PRO</span>
          </a>
        </div>
      </div>
    </div>

    <div id="alertBox" class="alert d-none" role="alert"></div>
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label" data-i18n="staff_language_label">Staff language</label>
          <select class="form-select" id="staffLanguage">
            <option value="" data-i18n="staff_language_default">Default</option>
            <option value="en">English</option>
          </select>
          <small class="text-muted" data-i18n="staff_language_hint">The language in which staff see task
            summaries.</small>
        </div>
        <div class="mb-3">
          <label class="form-label" data-i18n="staff_alert_phone">Alert phone (WhatsApp)</label>
          <input type="text" class="form-control" id="staffAlertPhone" placeholder="wa_id / phone"
            data-i18n-placeholder="staff_alert_phone_ph">
          <small class="text-muted" data-i18n="staff_alert_phone_hint">WhatsApp number for staff alerts (e.g.,
            reception).</small>
        </div>
        <div class="mt-3">
          <button class="btn btn-success" id="saveBtn" data-i18n="btn_save">Save</button>
        </div>
        <div class="mt-2">
          <span id="alertStatus" class="badge bg-secondary" data-i18n="staff_alerts_disabled">Alerts disabled</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    const tokenKey = "token";
    function getToken() {
      return localStorage.getItem(tokenKey);
    }
    function showAlert(msg, type = "info") {
      const box = document.getElementById("alertBox");
      box.textContent = msg;
      box.className = `alert alert-${type}`;
      box.classList.remove("d-none");
    }
    function updateAlertStatus(phone) {
      const el = document.getElementById("alertStatus");
      if (phone) {
        el.textContent = I18N.t('staff_alerts_enabled');
        el.className = "badge bg-success";
      } else {
        el.textContent = I18N.t('staff_alerts_disabled');
        el.className = "badge bg-secondary";
      }
    }
    async function loadSettings() {
      const token = getToken();
      if (!token) { window.location = "/ui/admin/login"; return; }
      const resp = await fetch("/api/admin/staff-settings", {
        headers: { "Authorization": `Bearer ${token}` }
      });
      if (!resp.ok) {
        showAlert(I18N.t('staff_load_failed'), "danger");
        return;
      }
      const data = await resp.json();
      document.getElementById("staffLanguage").value = data.staff_language || "";
      document.getElementById("staffAlertPhone").value = data.staff_alert_phone || "";
      updateAlertStatus(data.staff_alert_phone);
    }
    async function saveSettings() {
      const token = getToken();
      if (!token) { window.location = "/ui/admin/login"; return; }
      const payload = {
        staff_language: document.getElementById("staffLanguage").value || null,
        staff_alert_phone: document.getElementById("staffAlertPhone").value || null,
      };
      const resp = await fetch("/api/admin/staff-settings", {
        method: "PUT",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify(payload),
      });
      if (!resp.ok) {
        showAlert(I18N.t('staff_save_failed'), "danger");
        return;
      }
      const data = await resp.json();
      updateAlertStatus(data.staff_alert_phone);
      showAlert(I18N.t('staff_saved'), "success");
    }

    // Initialize language selector
    I18N.initSelect('lang-select');

    // Reload settings when language changes
    window.addEventListener('languageChanged', () => {
      loadSettings();
    });

    document.addEventListener("DOMContentLoaded", () => {
      loadSettings();
      document.getElementById("saveBtn").addEventListener("click", saveSettings);
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/js/subscription.js"></script>
  <script>
    // Hide PRO upgrade button for Thailand (PMS not available for LINE yet)
    function hideProButtonForThailand() {
      const hotelCountry = localStorage.getItem('hotelCountry');
      if (hotelCountry === 'TH') {
        document.querySelectorAll('a[href*="/upgrade-pro"]').forEach(btn => {
          btn.style.display = 'none';
        });
      }
    }
    document.addEventListener('DOMContentLoaded', hideProButtonForThailand);
  </script>
</body>

</html>